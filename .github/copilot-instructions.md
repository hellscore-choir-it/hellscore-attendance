# Copilot Instructions

- Project: Next.js 16 + React 19 app for Hellscore attendance; data flows through Google Calendar/Sheets and Supabase. UI pages live in `src/pages`, TRPC backend in `src/server/trpc`, Google integrations in `src/server/googleApis.ts`.
- Auth: Google via NextAuth ([src/pages/api/auth/[...nextauth].ts](src/pages/api/auth/%5B...nextauth%5D.ts)); TRPC context injects session ([src/server/trpc/context.ts](src/server/trpc/context.ts)), and mutations that require login use `protectedProcedure` ([src/server/trpc/trpc.ts](src/server/trpc/trpc.ts)).
- Routing/API: Single TRPC router `_app` exposes `google.submitAttendance` ([src/server/trpc/router/google.ts](src/server/trpc/router/google.ts)). Client is created in [src/utils/trpc.ts](src/utils/trpc.ts) and wrapped around `_app.tsx`.
- Data model: Attendance data primarily stored in Google Sheets; Supabase mirrors events/users for streaks and analytics ([src/server/db/userUpdateSideEffects.ts](src/server/db/userUpdateSideEffects.ts), [src/server/db/schema.ts](src/server/db/schema.ts)). Supabase IDs are SHA256-hashed emails (`generateSupabaseUserId`) and event IDs combine date/title with `||`.
- Core submission flow (keep consistent):
  - Frontend `AttendanceForm` calls `trpc.google.submitAttendance` ([src/components/AttendanceForm.tsx](src/components/AttendanceForm.tsx)). Text inputs are sanitized via `sanitizeText` before sending ([src/utils/attendanceSchema.ts](src/utils/attendanceSchema.ts)).
  - TRPC mutation authorizes user by reading Google Sheet user-event assignments, using retries and concurrency limits, and throws `UNAUTHORIZED` if the email is not mapped.
  - It writes a row to the `response` sheet and then updates Supabase (event presence + user streaks) serially via `performUpdateCallbacksSerially`.
  - If Supabase updates fail after a sheet write, the mutation logs to Sentry but does not reject (Google Sheet is the source of truth).
- Google integrations: `getHellscoreEvents` reads Calendar; `getUserEventTypeAssignments` and `writeResponseRow` hit Sheets using a global `RequestQueue` that enforces `MAX_CONCURRENT_GOOGLE_SHEET_REQUESTS` and `DELAY_BETWEEN_GOOGLE_SHEET_REQUESTS` ([src/server/common/RequestQueue.ts](src/server/common/RequestQueue.ts)). Retry logic with exponential backoff uses `doAsyncOperationWithRetry` and `isRetryableError` ([src/server/common/doAsyncOperationWithRetry.ts](src/server/common/doAsyncOperationWithRetry.ts), [src/utils/errors.ts](src/utils/errors.ts)). Prefer these utilities when adding new Google calls.
- Event matching: `getStaticProps` builds page props by matching Calendar summaries that start with sheet titles; keep new calendar entries prefixed with the title string from the sheet ([src/pages/index.tsx](src/pages/index.tsx)).
- Environment config: Validated with Zod in [src/env/schema.mjs](src/env/schema.mjs); `env/server.mjs` merges server+client. Add new env vars to the schema; server vars must not start with `NEXT_PUBLIC_`. Client-side Supabase uses `NEXT_PUBLIC_SUPABASE_URL/ANON_KEY` ([src/utils/supabase/client.ts](src/utils/supabase/client.ts)).
- Observability: Sentry initialized for edge/node ([src/instrumentation.ts](src/instrumentation.ts), [src/instrumentation-client.ts](src/instrumentation-client.ts)); client integration removes Fetch instrumentation to avoid Next.js 15/React 19/TRPC issues. Log unexpected failures with `captureException`/`captureMessage` as existing code does.
- Styling/UI: Tailwind (globals in `src/styles/globals.css`), Radix components, and Notistack snackbars. `SessionBoundary` gates pages on `useSession` and wraps `Layout`.
- Testing: Jest configured; current coverage centers on Google API utilities ([src/**tests**/server/googleApis.test.ts](src/__tests__/server/googleApis.test.ts)). Use `pnpm test` or `pnpm test:watch`.
- Local dev/build: use pnpm (lockfile present). Key scripts: `pnpm dev`, `pnpm build`, `pnpm start`, `pnpm lint`, `pnpm typecheck`, `pnpm test`. Next.js ISR set to `revalidate: 10` on the home page.
- Safety notes: Always sanitize user text before writing to Sheets; respect authorization by checking user-event assignments; keep API calls behind TRPC procedures that enforce session; when adding Sheet/Calendar requests, route through `RequestQueue` + retry helper to avoid rate limits.
